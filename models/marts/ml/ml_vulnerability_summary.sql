{{
    config(
        materialized='table'
    )
}}

with


disclosed_reports as (
    
    select * from {{ ref('fct_vulnerability') }}

),

aggregated as (

    select
        weakness_name,
        structured_scope_max_severity,
        listagg(vulnerability_information, ', ') as vulnerability_text
    from disclosed_reports
    where 
        structured_scope_max_severity is not null
        and substate = 'resolved'
    group by 1, 2

),

final as (

    select
        weakness_name,
        structured_scope_max_severity,
        snowflake.cortex.summarize(vulnerability_text)
    from aggregated

)

select * from final
